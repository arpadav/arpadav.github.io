<!doctype html><meta content="text/html; charset=utf-8" charset=utf-8 http-equiv=Content-Type><title>20250726-immich-proxy-truenas.md - Arpad Voros</title><link href=/images/site.webmanifest rel=manifest><link href=/images/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/images/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/images/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><script src="https://www.googletagmanager.com/gtag/js?id=G-8RV0KPZZXQ" async></script><script>window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8RV0KPZZXQ');</script></head><div class=sidebar id=sidebar><li><a href=/gator/ target=_parent> <img style="width: 268px;" src=/images/alligator.png> </a></div><div class=beside-sidebar><div class=navbar id=navbar><ul><li><a href=/# target=_parent>home</a><li><a href=/#about target=_parent>about</a><li><a href=/#contact target=_parent>contact</a><li><a href=/#socials target=_parent>socials</a><li><a href=/cv.pdf target=_parent>cv</a><li><a href=/projects target=_parent>projects</a><li><a href=/notes target=_parent>notes</a></ul></div></div><div id=markdown-content><style>#markdown-content h1 {
            margin-top: 0%;
        }
        #markdown-content img {
            max-width: 50vw;
            max-height: 70vh;
            margin: 0 auto;
            display: block;
            object-fit: contain;
        }</style><style>code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
      }
    pre.numberSource { margin-left: 3em;  padding-left: 4px; }
    div.sourceCode
      { color: #cccccc; background-color: #303030; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ffcfaf; } /* Alert */
    code span.an { color: #7f9f7f; font-weight: bold; } /* Annotation */
    code span.at { } /* Attribute */
    code span.bn { color: #dca3a3; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #f0dfaf; } /* ControlFlow */
    code span.ch { color: #dca3a3; } /* Char */
    code span.cn { color: #dca3a3; font-weight: bold; } /* Constant */
    code span.co { color: #7f9f7f; } /* Comment */
    code span.cv { color: #7f9f7f; font-weight: bold; } /* CommentVar */
    code span.do { color: #7f9f7f; } /* Documentation */
    code span.dt { color: #dfdfbf; } /* DataType */
    code span.dv { color: #dcdccc; } /* DecVal */
    code span.er { color: #c3bf9f; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #c0bed1; } /* Float */
    code span.fu { color: #efef8f; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #7f9f7f; font-weight: bold; } /* Information */
    code span.kw { color: #f0dfaf; } /* Keyword */
    code span.op { color: #f0efd0; } /* Operator */
    code span.ot { color: #efef8f; } /* Other */
    code span.pp { color: #ffcfaf; font-weight: bold; } /* Preprocessor */
    code span.sc { color: #dca3a3; } /* SpecialChar */
    code span.ss { color: #cc9393; } /* SpecialString */
    code span.st { color: #cc9393; } /* String */
    code span.va { } /* Variable */
    code span.vs { color: #cc9393; } /* VerbatimString */
    code span.wa { color: #7f9f7f; font-weight: bold; } /* Warning */</style><link href=/css/std.css rel=stylesheet><body><h1 id=setting-up-immich-public-proxy-on-truenas-scale>setting up Immich-Public-Proxy on TrueNAS Scale</h1><p>TLDR: Use Cloudflare!!!!<p>There are plenty of tutorials on how to transfer your domain to Cloudflare from any other registrar (e.g., I was originally on GoDaddy), so this step is purposefully not included. A basic overview is to change your nameservers to Cloudflare on the original registrar, then turn off all "locks" on the domain to initiate transfer, get an authorization code, import into Cloudflare, wait some time for DNS to update, then import into Cloudflare, then done.<p>See my <a href=#struggle>struggle</a> at the end to understand how I got here.<p><a href=https://images.arpadvoros.com/share/zHZ_RlibRuu-D-mDv8lnpYRr3sv7ySpxGBSyzK3dN-K8qAXWoyr_MZMIm6zmr8Gai48>result :) click me to see a picture of my beautiful childhood pet cat</a><h2 id=goals>goals</h2><ol type=1><li>Share read-only images/albums with friends on my website @ <code>images.arpadvoros.com</code><li>Host images on my TrueNAS Scale NAS using Immich<li>Click <code>Share</code> and fetch a link (with/without password)<li>Secure with HTTPS</ol><h2 id=assumptions>assumptions</h2><ol type=1><li>User is using TrueNAS Scale<li>User has Immich installed as a TrueNAS app (just Docker)<li>User has a domain on Cloudflare</ol><h2 id=steps>steps</h2><h3 id=install-immich-public-proxy-as-custom-truenas-app>Install Immich Public Proxy as Custom TrueNAS App</h3><p><a href=https://github.com/alangrainger/immich-public-proxy>Immich Public Proxy</a> is a tool to only expose read-only endpoints of Immich, preventing things like the <code>/api</code> endpoint or writable endpoints. This is at least my understanding.<p>On TrueNAS, this app does not exist. It must be installed manually.<p>I would highly recommend <a href="https://www.youtube.com/watch?v=gPL7_tzsJO8">this video by Techno Tim</a> on the best approach to install apps manually on TrueNAS. It makes things easy, and I version control all of mine through a private git repo.<p>A TLDR of the video is:<ol type=1><li><p>Log into TrueNAS<li><p>Go to <code>Datasets -> Add Dataset</code><li><p>Create one for your custom app. In this case, I called mine <code>immich-public-proxy</code><li><p>This creates a folder called <code>&lt;path-to-pool>/immich-public-proxy</code>. Set permissions if need be (explained in video)<li><p>Add any <code>docker-compose.yml</code> file inside of <code>&lt;path-to-pool>/immich-public-proxy</code><li><p>Navigate to <code>Apps -> Discover Apps -> ... Install via YAML</code><li><p>Add the following:</p> <div class=sourceCode id=cb1><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id=cb1-1><a aria-hidden=true href=#cb1-1 tabindex=-1></a><span class=fu>include</span><span class=kw>:</span></span>
<span id=cb1-2><a aria-hidden=true href=#cb1-2 tabindex=-1></a><span class=at>  </span><span class=kw>-</span><span class=at> </span><span class=st>"&lt;path-to-pool>/immich-public-proxy/compose.yml"</span></span></code></pre></div><li><p>Click <code>Save</code> and you can now see your custom app!</ol><h3 id=configure-immich-public-proxy>Configure Immich Public Proxy</h3><p>The instructions above were for any Docker Compose YAML file -> custom TrueNAS app. These instructions are explicitly for Immich Public Proxy.<ol type=1><li>Copy-paste <a href=https://github.com/alangrainger/immich-public-proxy/blob/main/docker-compose.yml>this <code>docker-compose.yml</code></a> into <code>&lt;path-to-pool>/immich-public-proxy/compose.yml</code><li>Change <code>PUBLIC_BASE_URL</code> to your domain, e.g., <code>images.arpadvoros.com</code> for me. Even if this domain is not yet configured, don't worry.<li>Change <code>IMMICH_URL</code> to the URL of your Immich instance. This can <strong>not</strong> be <code>localhost</code> since this URL is defined within the Docker container. It must be a static IP or some domain name of your NAS. For example, <code>192.168.0.100:30041</code>.<li>I would recommend adding another environment variable called <code>IPP_PORT</code> to customize your port value. Ensure to modify the <code>ports</code> and <code>healthcheck</code> sections with that hard-coded port. If this is not done, it will <strong>always</strong> default to 3000, which prevents the healthcheck from working and looks like the app is not running. This environment variable is not documented in the repo, but you can search for it in issues and <a href=https://github.com/alangrainger/immich-public-proxy/blob/93b6e6ef5171ec0cd6600c6c4af2659527560b34/app/src/index.ts#L186>also here</a>.</ol><p>To verify all this, I would navigate over to Immich and try to get a share link. This share link will give you the following format:<p><code>http[s]://&lt;NAS-IP>:&lt;IMMICH-PORT>/share/&lt;UID></code><p>Go ahead and <em><strong>just</strong></em> change the port from the Immich port to the Immich Public Proxy port, and if you can see the image then the proxy is running properly. Ensure to also check the logs via Docker or via the TrueNAS apps logs.<h3 id=using-cloudflared-tunnel>Using Cloudflared Tunnel</h3><p>Documentation:<ul><li><a href=https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/>https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/</a></ul><p>My instructions:<ol type=1><li><p>On TrueNAS, look for the <a href=https://github.com/cloudflare/cloudflared><code>Cloudflared</code></a> app<li><p>During installation, it will ask for a Tunnel API token<li><p>Navigate to <a href=https://one.dash.cloudflare.com/>Zero Trust - Cloudflare Dashboard</a><li><p>Go to <code>Networks -> Tunnels -> Create a tunnel</code><li><p>Select <code>Cloudflared</code><li><p>Enter a descriptive name for the tunnel. This is <strong>not</strong> the service, so name it something like <code>mynas</code><li><p>Copy the Docker command. Don't run it, just copy the token out of it<li><p>Return to TrueNAS (step 2) and enter the token there. Create the <code>Cloudflared</code> TrueNAS app<li><p>Return to Cloudflare, click <code>Public hostnames</code> to add one<li><p>Add:</p> <div class=sourceCode id=cb2><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id=cb2-1><a aria-hidden=true href=#cb2-1 tabindex=-1></a>**Subdomain**: images</span>
<span id=cb2-2><a aria-hidden=true href=#cb2-2 tabindex=-1></a>**Domain**: arpadvoros.com</span>
<span id=cb2-3><a aria-hidden=true href=#cb2-3 tabindex=-1></a>**Service Type**: HTTP      _# this is internal / local. It is HTTP locally, but HTTPS via the Cloudflare tunnel. You can set this to HTTPS if you have Immich configured as such._</span>
<span id=cb2-4><a aria-hidden=true href=#cb2-4 tabindex=-1></a>**URL**: NAS_IP:IPP_PORT    _# this is the Immich Public Proxy env variable, see above._</span></code></pre></div><li><p>Click <code>Save</code></ol><p>And it should be magically done! Now you can modify in your Immich settings the endpoint of your share links. And now you will automatically have HTTPS thanks to Cloudflare, the URL will automatically be forwarding to the Cloudflared tunnel to your NAS:IPP_PORT, and it should just work. This was far easier than the struggle I initially had with a bunch more moving parts. Read below.<h2 id=notes>notes</h2><p>Previously I was using DuckDNS for DDNS resolution, I wanted HTTPS using Caddy, custom certificate generation, port forwarding on my router, etc.<p>And it did not help that I was using GoDaddy, which barely had any options for advanced configuration, and my router was also awful. I spent 4+ hours the other day running around in circles to get this to work with no avail. I definitely learned a lot, however, the fact that at the end of the day it <strong>still</strong> did not work and it was completely out of my hands (due to GoDaddy and my router not allowing advanced configuration) was extremely frustrating. I have been using DuckDNS in the past for DDNS resolution but after searching online, it looked like Cloudflare solved all my issues:<ul><li>Domain registration + purchase<li>Allowed for advanced configuration of DNS<li>Using <code>Cloudflared</code>, set up a tunnel rather than a traditional DDNS solution like DuckDNS<li>No port-forwarding required, since <code>Cloudflared</code> also solved this<li>All free, similar to previous solutions, but under one provider</ul><p>The only thing I had to pay for at the end of the day was the registrar transfer, moving my domain from GoDaddy -> Cloudflare. Which was like 10 bucks and so worth it.<h2 id=struggle>struggle</h2><p>Rather than going into detail, I will just relay my ChatGPT conversation so you can see the insanity I was attempting to tie together and failing to do so. It did not help that my <a href=https://www.tp-link.com/us/business-networking/soho-festa-gateway/festa-fr205/>router (TP-Link Festa FR205)</a> absolutely sucks in terms of configurability… In order to port-forward anything or manage your router you can NOT just log into the default web interface, but go through some TP-Link cloud?? And then you lose DHCP functionality/access/control, and once you have the cloud configured you can no longer log in locally?? It is awful…..<p>Anyways, here is the gist of the initial approach prior to moving to Cloudflare:<div class=sourceCode id=cb3><pre class="sourceCode markdown"><code class="sourceCode markdown"><span id=cb3-1><a aria-hidden=true href=#cb3-1 tabindex=-1></a>a lot of moving parts. need your help.</span>
<span id=cb3-2><a aria-hidden=true href=#cb3-2 tabindex=-1></a></span>
<span id=cb3-3><a aria-hidden=true href=#cb3-3 tabindex=-1></a>context: networking help to expose a read-only API on my NAS to the world wide web to share images/albums with friends</span>
<span id=cb3-4><a aria-hidden=true href=#cb3-4 tabindex=-1></a></span>
<span id=cb3-5><a aria-hidden=true href=#cb3-5 tabindex=-1></a><span class=ss>1. </span>i have a NAS which runs truenas scale</span>
<span id=cb3-6><a aria-hidden=true href=#cb3-6 tabindex=-1></a><span class=ss>2. </span>on said NAS, i have immich which stores my images locally</span>
<span id=cb3-7><a aria-hidden=true href=#cb3-7 tabindex=-1></a><span class=ss>3. </span>i see <span class=in>`immich public proxy`</span> (ipp) project, which prevents exposing the /api endpoint and ensures any external user stays as read-only</span>
<span id=cb3-8><a aria-hidden=true href=#cb3-8 tabindex=-1></a><span class=ss>4. </span>on the ipp repo, it is recommended to use Caddy to forward expose this port on https. it also gives instructions on how to make a certificate</span>
<span id=cb3-9><a aria-hidden=true href=#cb3-9 tabindex=-1></a><span class=ss>5. </span>i have a domain on Godaddy under myname.com. id want to share images to images.myname.com</span>
<span id=cb3-10><a aria-hidden=true href=#cb3-10 tabindex=-1></a><span class=ss>6. </span>i dont have a static IP with my ISP, so i am using duckdns at myname.duckdns.org</span>
<span id=cb3-11><a aria-hidden=true href=#cb3-11 tabindex=-1></a><span class=ss>7. </span>my NAS has a cron job which executed (6) to keep the ip's up to date, however, due to some misconfiguration(?) it exposes my routers IP address</span>
<span id=cb3-12><a aria-hidden=true href=#cb3-12 tabindex=-1></a><span class=ss>8. </span>my router is a tp link festa and it barely has any options for port forwarding...</span>
<span id=cb3-13><a aria-hidden=true href=#cb3-13 tabindex=-1></a></span>
<span id=cb3-14><a aria-hidden=true href=#cb3-14 tabindex=-1></a>given ALL this, here is what went down:</span>
<span id=cb3-15><a aria-hidden=true href=#cb3-15 tabindex=-1></a><span class=ss>1. </span>if i add CNAME images myname.duckdns.org on GoDaddy, it literally exposes my router's web portal to the WWW... **very bad**</span>
<span id=cb3-16><a aria-hidden=true href=#cb3-16 tabindex=-1></a><span class=ss>2. </span>my immich server works without issue. the IPP also works, since it runs locally on port 3000. so i am able to check health and see my shared pictures there</span>
<span id=cb3-17><a aria-hidden=true href=#cb3-17 tabindex=-1></a><span class=ss>3. </span>my caddy configuration should be forwarding port 3000 to images.myname.com, but it gives an error with the certificate signing about how there is no A or AAAA record in for images.myname.com</span>
<span id=cb3-18><a aria-hidden=true href=#cb3-18 tabindex=-1></a></span>
<span id=cb3-19><a aria-hidden=true href=#cb3-19 tabindex=-1></a>however, on GoDaddy i cant add an A or AAAA record without it being a static ip address</span>
<span id=cb3-20><a aria-hidden=true href=#cb3-20 tabindex=-1></a></span>
<span id=cb3-21><a aria-hidden=true href=#cb3-21 tabindex=-1></a>so my question is:</span>
<span id=cb3-22><a aria-hidden=true href=#cb3-22 tabindex=-1></a></span>
<span id=cb3-23><a aria-hidden=true href=#cb3-23 tabindex=-1></a><span class=ss>1. </span>any way to accomplish my goals without tls/https and not have a need for caddy?</span>
<span id=cb3-24><a aria-hidden=true href=#cb3-24 tabindex=-1></a><span class=ss>2. </span>how to ensure caddy works correctly and properly setting up https?</span>
<span id=cb3-25><a aria-hidden=true href=#cb3-25 tabindex=-1></a></span>
<span id=cb3-26><a aria-hidden=true href=#cb3-26 tabindex=-1></a>please search the web and be thorough</span></code></pre></div></div><br>